rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of a specific document
    function isOwner(doc) {
      return isSignedIn() && doc.owner == request.auth.uid;
    }
    
    // Helper function to check if user has write access to a specific document
    function hasWriteAccess(doc) {
      return isSignedIn() &&
             (isOwner(doc) ||
              (doc.writeAccess is list && 
               request.auth.uid in doc.writeAccess));
    }
    
    // Helper function to check if user has read access to a specific document
    function hasReadAccess(doc) {
      return doc.isPublic == true ||
             isOwner(doc) ||
             (isSignedIn() && 
              ((doc.readAccess is list && request.auth.uid in doc.readAccess) ||
               (doc.writeAccess is list && request.auth.uid in doc.writeAccess)));
    }
    
    // =================================================================
    // Stories collection rules
    // =================================================================
    match /stories/{storyId} {
      // GET - Single document reads use complex access checks on the resource
      allow get: if hasReadAccess(resource.data);
      
      // LIST - Allow queries for authenticated users or public stories
      allow list: if isSignedIn() || resource.data.isPublic == true;

      // CREATE - Only authenticated users can create stories for themselves
      // Required fields: owner, isPublic, readAccess, writeAccess, title, created, lastUpdated, lastUpdatedBy, isArchived
      allow create: if isSignedIn() &&
                       isOwner(request.resource.data) &&
                       request.resource.data.keys().hasAll(['owner', 'isPublic', 'readAccess', 'writeAccess', 'title', 'created', 'lastUpdated', 'lastUpdatedBy', 'isArchived']) &&
                       request.resource.data.isPublic is bool &&
                       request.resource.data.isArchived is bool &&
                       request.resource.data.readAccess is list &&
                       request.resource.data.writeAccess is list;

      // UPDATE - Only owner or users with write access can update
      allow update: if hasWriteAccess(resource.data);

      // DELETE - Only owner can delete
      allow delete: if isOwner(resource.data);

      // Y.js collaboration subcollections
      // For performance, we allow any authenticated user to read/write the collaboration data
      // The parent document access controls who can actually collaborate
      match /instances/{instanceId=**} {
        allow read, write: if isSignedIn();
      }

      // ---------------------------------------------------------------
      // Comments subcollection
      // ---------------------------------------------------------------
      match /comments/{commentId} {
        allow read: if hasReadAccess(get(/databases/$(database)/documents/stories/$(storyId)).data);

        // Create if signed in and can read the story; authorId must be self
        allow create: if isSignedIn() &&
                       hasReadAccess(get(/databases/$(database)/documents/stories/$(storyId)).data) &&
                       request.resource.data.authorId == request.auth.uid;

        // Update only by author
        allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;

        // Delete by author or story owner
        allow delete: if isSignedIn() && (
          request.auth.uid == resource.data.authorId ||
          isOwner(get(/databases/$(database)/documents/stories/$(storyId)).data)
        );

        // Likes under a comment
        match /likes/{uid} {
          allow read: if hasReadAccess(get(/databases/$(database)/documents/stories/$(storyId)).data);
          allow create, update, delete: if isSignedIn() && request.auth.uid == uid;
        }
      }
    }
    
    // =================================================================
    // Users collection rules
    // =================================================================
    match /users/{userId} {
      // Allow anyone to read user profiles
      allow read: if true;
      
      // Only the user can write their own profile
      allow write: if isSignedIn() && request.auth.uid == userId;

      // Followers: anyone can read; only the follower can create/delete their entry
      match /followers/{followerId} {
        allow read: if true;
        allow create, delete: if isSignedIn() && request.auth.uid == followerId;
      }

      // Following: anyone can read; only the owner can create/delete their following entries
      match /following/{followedId} {
        allow read: if true;
        allow create, delete: if isSignedIn() && request.auth.uid == userId;
      }
    }
    
    // =================================================================
    // Credentials collection (Server-Only/Admin SDK)
    // =================================================================
    // This collection stores password hashes for users with email/password auth
    // Completely isolated from public users collection for security
    match /credentials/{credentialId} {
      // No client access allowed - only Firebase Admin SDK can access
      allow read, write: if false;
    }
    
    // =================================================================
    // NextAuth Collections (Server-Only/Admin SDK)
    // =================================================================
    
    // Deny all direct client access to these collections
    match /sessions/{sessionId} {
      allow read, write: if false;
    }
    
    match /accounts/{accountId} {
      allow read, write: if false;
    }
  }
}
